// Geofence Application Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String   // bcrypt hashed
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Geofence {
  id          String          @id @default(cuid())
  name        String
  coordinates Json            // Array of exactly 8 {lat: number, lng: number} points
  enabled     Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  events      GeofenceEvent[] // Relation to events

  @@index([enabled])
}

// Track user geofence state for server-side evaluation
model UserGeofenceState {
  id                String   @id @default(cuid())
  appId             String   @default("default-app")
  userId            String
  activeGeofenceIds String[] // Array of currently active geofence IDs
  lastLatitude      Float
  lastLongitude     Float
  lastReportedAt    DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([appId, userId])
  @@index([appId])
  @@index([userId])
}

// Log all geofence enter/exit events
model GeofenceEvent {
  id         String   @id @default(cuid())
  appId      String   @default("default-app")
  userId     String
  eventType  String   // 'enter' or 'exit'
  geofenceId String
  geofence   Geofence @relation(fields: [geofenceId], references: [id], onDelete: Cascade)
  latitude   Float
  longitude  Float
  accuracy   Float?
  speed      Float?
  heading    Float?
  timestamp  DateTime
  createdAt  DateTime @default(now())

  @@index([appId])
  @@index([userId])
  @@index([geofenceId])
  @@index([eventType])
  @@index([timestamp])
}
